import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, getDocs, onSnapshot, query, addDoc, deleteDoc } from 'firebase/firestore';
import { 
  Plus, Trash2, Printer, Eye, Settings, Layout, Type, CheckSquare, Split, 
  ListOrdered, HelpCircle, Minus, List as ListIcon, Square, Table as TableIcon, 
  Grid3X3, Layers, CircleDot, CheckCircle2, Image as ImageIcon, FileText, 
  KeyRound, School, Shuffle, Columns, Info, Beaker, Sigma, MoveVertical,
  ChevronDown, BookOpen, Languages, Globe, History, Zap, Sparkles, ArrowRight,
  Cloud, Share2, Search, ExternalLink, X, Play, MousePointer2, AlignJustify, 
  Copy, AlertCircle, Check, Hash, RotateCcw, Target, Library, Save, HelpCircle as HelpIcon
} from 'lucide-react';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'makedo-test-v6-ultimate';

// --- Компонента за прецизно СТЕМ рендерирање ---
const RenderContent = ({ text, view, className = "" }) => {
  if (!text) return null;
  
  // Регех за детектирање на $формула$, {избор}, [празно]
  const parts = text.split(/(\$.*?\$|\{.*?\}|\[.*?\])/g);

  return (
    <span className={className}>
      {parts.map((part, i) => {
        if (!part) return null;

        // 1. Математика (LaTeX стил)
        if (part.startsWith('$') && part.endsWith('$')) {
          const formula = part.slice(1, -1)
            .replace(/\\sqrt\{(.+?)\}/g, '√$1')
            .replace(/\\sqrt/g, '√')
            .replace(/\^\{(.+?)\}/g, '<sup>$1</sup>')
            .replace(/\^(\d+)/g, '<sup>$1</sup>')
            .replace(/_\{(.+?)\}/g, '<sub>$1</sub>')
            .replace(/_(\d+)/g, '<sub>$1</sub>')
            .replace(/\\frac\{(.+?)\}\{(.+?)\}/g, '($1/$2)')
            .replace(/\\cdot/g, '·')
            .replace(/\\approx/g, '≈')
            .replace(/\\pi/g, 'π')
            .replace(/\\pm/g, '±');

          return (
            <span 
              key={`math-${i}`} 
              className="font-serif italic text-indigo-700 bg-indigo-50/50 px-1 rounded mx-0.5 border-b border-indigo-200 inline-block leading-none"
              dangerouslySetInnerHTML={{ __html: formula }}
            />
          );
        }

        // 2. Инлајн селекција
        if (part.startsWith('{') && part.endsWith('}')) {
          const content = part.slice(1, -1);
          const options = content.split('|');
          if (view === 'answerKey') {
            return <span key={`sel-${i}`} className="mx-1 px-2 py-0.5 rounded bg-emerald-100 text-emerald-700 font-black border border-emerald-300 underline shadow-sm">{options[0]}</span>;
          }
          return <span key={`sel-${i}`} className="mx-1 px-3 py-1 rounded-xl border-2 border-slate-200 bg-slate-50 italic text-slate-400 text-sm font-medium">избери одговор</span>;
        }

        // 3. Празни места
        if (part.startsWith('[') && part.endsWith(']')) {
          const answer = part.slice(1, -1);
          if (view === 'answerKey') {
            return <span key={`blank-${i}`} className="mx-1 font-bold text-indigo-600 underline decoration-indigo-400 decoration-2">{answer}</span>;
          }
          return <span key={`blank-${i}`} className="inline-block border-b-2 border-slate-900 min-w-[120px] mx-1 h-1 shadow-sm"></span>;
        }

        // 4. Обичен текст
        return <span key={`txt-${i}`}>{part}</span>;
      })}
    </span>
  );
};

const App = () => {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('landing'); 
  const [showTutorial, setShowTutorial] = useState(false);
  const [tutorialStep, setTutorialStep] = useState(0);
  const [sharedTests, setSharedTests] = useState([]);
  const [questionBank, setQuestionBank] = useState([]);
  const [isLoading, setIsLoading] = useState(false);
  const [demoStep, setDemoStep] = useState(0);
  const [duplicateAlert, setDuplicateAlert] = useState(null);

  const [testInfo, setTestInfo] = useState({
    schoolType: "ООУ", school: "„Македонија“", subject: "Природни Науки",
    teacher: "Наставник", title: "Тест за знаење", date: new Date().toLocaleDateString('mk-MK'),
    grade: "VII", alignment: "left", zipGrade: false, watermark: "", subNumbering: false,
  });

  const [questions, setQuestions] = useState([
    {
      id: 1, type: 'multiple', text: 'Пресметај ја плоштината на круг со радиус $r = 5cm$ ако $\\pi \\approx 3.14$?',
      options: ['$78.5cm^2$', '$31.4cm^2$', '$25cm^2$'], correct: 0, columns: 3, points: 5, subNum: ""
    }
  ]);

  const totalPoints = useMemo(() => questions.reduce((acc, q) => acc + Number(q.points || 0), 0), [questions]);

  const questionTypes = [
    { id: 'multiple', label: 'Понудени одговори', icon: <CheckSquare size={16} />, cat: 'базични' },
    { id: 'true-false', label: 'Точно/Неточно', icon: <HelpCircle size={16} />, cat: 'базични' },
    { id: 'fill-blanks', label: 'Пополни празнини', icon: <Minus size={16} />, cat: 'текстуални' },
    { id: 'selection', label: 'Селекција (Инлајн)', icon: <CircleDot size={16} />, cat: 'напредни' },
    { id: 'multi-match', label: 'Мулти-поврзување', icon: <Grid3X3 size={16} />, cat: 'логички' },
    { id: 'short-answer', label: 'Краток одговор', icon: <Type size={16} />, cat: 'текстуални' },
    { id: 'essay', label: 'Есеј / Долг одговор', icon: <FileText size={16} />, cat: 'текстуални' },
    { id: 'matching', label: 'Поврзување', icon: <Split size={16} />, cat: 'логички' },
    { id: 'ordering', label: 'Подредување', icon: <ListOrdered size={16} />, cat: 'логички' },
    { id: 'list', label: 'Листа (набројување)', icon: <ListIcon size={16} />, cat: 'листа' },
    { id: 'table', label: 'Табела', icon: <TableIcon size={16} />, cat: 'напредни' },
    { id: 'multi-part', label: 'Мулти-дел (а, б, в)', icon: <Layers size={16} />, cat: 'напредни' },
    { id: 'diagram', label: 'Дијаграм / Цртеж', icon: <ImageIcon size={16} />, cat: 'напредни' },
    { id: 'statements', label: 'Изјави (Т/Н листа)', icon: <CheckCircle2 size={16} />, cat: 'базични' },
  ];

  const tutorialSteps = [
    { title: "Добредојдовте!", text: "Ова е МакедоТест Про v6.0. Ајде да ја разгледаме околината.", targetId: "main-nav" },
    { title: "Банка на Прашања", text: "Овде се чуваат Вашите омилени задачи за повторно користење.", targetId: "bank-tab" },
    { title: "Сите 16 Формати", text: "Додадете прашање со еден клик: СТЕМ табели, инлајн селекција и многу повеќе.", targetId: "toolbox-sidebar" },
    { title: "v6.0 Напредни Поставки", text: "Активирајте го ZipGrade стилот, оправданиот текст или под-нумерирањето.", targetId: "advanced-settings" },
    { title: "Вашиот Тест", text: "Ова е Вашето платно. Рендерирањето е во реално време со СТЕМ поддршка.", targetId: "test-paper" },
    { title: "Печатење", text: "Кога ќе завршите, испечатете го тестот на чист А4 формат.", targetId: "action-buttons" }
  ];

  // Auth & Listeners
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else { await signInAnonymously(auth); }
      } catch (err) { console.error(err); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const unsubBank = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'question_bank'), (s) => {
      setQuestionBank(s.docs.map(d => ({ id: d.id, ...d.data() })));
    });
    return () => unsubBank();
  }, [user]);

  useEffect(() => {
    const timer = setInterval(() => setDemoStep((p) => (p + 1) % 3), 4000);
    return () => clearInterval(timer);
  }, []);

  const handlePrint = () => {
    window.focus();
    window.print();
  };

  const addQuestion = (type) => {
    const baseQ = { id: Date.now(), type, text: '', points: 5, columns: 1 };
    if (type === 'multiple') { baseQ.options = ['', '', '']; baseQ.correct = 0; }
    else if (type === 'matching') { baseQ.pairs = [{l:'', r:''}, {l:'', r:''}]; }
    else if (type === 'table') { baseQ.tableData = { rows: 3, cols: 3 }; }
    setQuestions([...questions, baseQ]);
  };

  const saveToBank = async (q) => {
    if (!user) return;
    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'question_bank'), { ...q });
    setDuplicateAlert("Додадено во банката!");
    setTimeout(() => setDuplicateAlert(null), 2000);
  };

  const LandingPage = () => (
    <div className="min-h-screen bg-white relative overflow-hidden font-sans">
      <nav className="px-8 py-6 flex justify-between items-center max-w-7xl mx-auto relative z-10">
        <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('landing')}>
          <div className="bg-indigo-600 p-2.5 rounded-2xl shadow-lg shadow-indigo-100"><Zap className="text-white" size={32} /></div>
          <span className="text-2xl font-black tracking-tighter uppercase text-slate-900">МакедоТест</span>
        </div>
        <button onClick={() => setView('editor')} className="bg-slate-900 text-white px-8 py-3 rounded-2xl text-sm font-bold shadow-xl hover:scale-105 transition">Едитор</button>
      </nav>

      <main className="max-w-7xl mx-auto px-8 pt-20 grid lg:grid-cols-2 gap-16 items-center relative z-10">
        <div className="space-y-10 animate-in slide-in-from-left duration-700">
          <div className="inline-flex items-center gap-2 bg-indigo-50 border border-indigo-100 px-4 py-2 rounded-full">
            <Sparkles size={16} className="text-indigo-600" />
            <span className="text-xs font-black text-indigo-700 uppercase tracking-widest tracking-tighter">v6.0 Pro со СТЕМ поддршка</span>
          </div>
          <h1 className="text-7xl font-black text-slate-900 leading-[1.1] tracking-tighter text-balance">Креирајте <span className="text-indigo-600">професионални</span> тестови во минути.</h1>
          <p className="text-xl text-slate-500 leading-relaxed max-w-md font-medium">Најнапредниот софтвер за наставници во Македонија. Подготвен за печатење на А4.</p>
          <div className="flex gap-6">
            <button onClick={() => setView('editor')} className="bg-indigo-600 text-white px-10 py-5 rounded-3xl font-black shadow-2xl flex items-center gap-3 hover:bg-indigo-700 transition active:scale-95 text-lg">Креирај нов тест <ArrowRight size={22} /></button>
            <button onClick={() => { setView('editor'); setShowTutorial(true); setTutorialStep(0); }} className="bg-white border-2 border-slate-100 px-10 py-5 rounded-3xl font-black flex items-center gap-3 hover:border-indigo-100 transition text-lg"><Play size={22} /> Види како работи</button>
          </div>
        </div>

        <div className="relative group cursor-pointer" onClick={() => setView('editor')}>
          <div className="absolute -inset-10 bg-indigo-500/5 rounded-full blur-3xl animate-pulse"></div>
          <div className="relative bg-white p-12 rounded-[3.5rem] shadow-2xl border border-slate-100 flex flex-col gap-10 transform group-hover:scale-[1.02] transition-all duration-500">
             <div className="flex justify-between items-center">
                <div className="bg-indigo-50 text-indigo-600 px-5 py-1.5 rounded-full text-[11px] font-black uppercase tracking-widest">v6.0 ДЕМО</div>
                <div className="flex gap-2">
                   {[0, 1, 2].map(i => <div key={i} className={`h-2.5 rounded-full transition-all duration-500 ${demoStep === i ? 'bg-indigo-500 w-6' : 'bg-slate-100 w-2.5'}`} />)}
                </div>
             </div>
             <div className="min-h-[140px] flex items-center text-4xl font-black text-slate-900 leading-tight">
                {demoStep === 0 ? <RenderContent text="Сила $F = m \\cdot a$" /> : demoStep === 1 ? <RenderContent text="$\\sqrt{144} + 2^3$" /> : <RenderContent text="Процес: [фотосинтеза]" />}
             </div>
             <div className="bg-slate-50/50 p-10 rounded-[2.5rem] border border-dashed border-slate-200 flex items-center justify-center text-slate-400 font-bold italic text-xl shadow-inner">
                Пример за СТЕМ приказ
             </div>
          </div>
        </div>
      </main>
    </div>
  );

  if (view === 'landing') return <LandingPage />;

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-900 pb-20 relative overflow-x-hidden">
      
      {/* Tutorial Highlighting and Overlay */}
      {showTutorial && (
        <>
          <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-[2px] z-[100] pointer-events-none"></div>
          <div className="fixed inset-0 z-[150] flex items-end justify-center pb-20 pointer-events-none px-4">
             <div className="bg-white w-full max-w-md rounded-[2.5rem] p-10 shadow-[0_30px_60px_-12px_rgba(0,0,0,0.5)] relative pointer-events-auto border border-slate-100 animate-in fade-in slide-in-from-bottom-5 duration-500">
                <button onClick={() => setShowTutorial(false)} className="absolute top-8 right-8 text-slate-400 hover:text-slate-900 transition"><X size={24} /></button>
                <div className="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center text-white mb-6 shadow-lg shadow-indigo-100"><Target size={32} /></div>
                <h2 className="text-3xl font-black mb-3 tracking-tighter text-slate-900 leading-none">{tutorialSteps[tutorialStep].title}</h2>
                <p className="text-slate-500 leading-relaxed mb-10 text-lg font-medium">{tutorialSteps[tutorialStep].text}</p>
                <div className="flex items-center justify-between">
                   <div className="flex gap-2">
                      {tutorialSteps.map((_, i) => (
                        <div key={i} className={`h-2 rounded-full transition-all duration-300 ${i === tutorialStep ? 'w-10 bg-indigo-600' : 'w-2 bg-slate-200'}`}></div>
                      ))}
                   </div>
                   <button 
                    onClick={() => tutorialStep < tutorialSteps.length - 1 ? setTutorialStep(s => s + 1) : setShowTutorial(false)} 
                    className="bg-slate-900 text-white px-10 py-4 rounded-2xl font-black text-sm shadow-xl hover:bg-indigo-600 transition"
                   >
                     {tutorialStep < tutorialSteps.length - 1 ? 'Следно' : 'Започни'}
                   </button>
                </div>
             </div>
          </div>
        </>
      )}

      {/* Navbar */}
      <nav id="main-nav" className={`bg-white border-b border-slate-200 px-8 py-4 flex items-center justify-between sticky top-0 z-[110] shadow-sm print:hidden transition-all duration-500 ${showTutorial && tutorialStep === 0 ? 'ring-[8px] ring-indigo-500/50 shadow-2xl bg-white' : ''}`}>
        <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('landing')}>
          <div className="bg-indigo-600 p-2 rounded-xl text-white shadow-lg"><Zap size={20} /></div>
          <span className="font-black text-lg uppercase tracking-tighter">МакедоТест</span>
        </div>
        <div className="flex bg-slate-100 p-1 rounded-2xl shadow-inner">
          {['editor', 'preview', 'answerKey'].map(v => (
            <button key={v} onClick={() => setView(v)} className={`px-6 py-2 rounded-xl text-[11px] font-black uppercase transition ${view === v ? 'bg-white text-indigo-600 shadow-md' : 'text-slate-500 hover:text-slate-900'}`}>
              {v === 'editor' ? 'Уреди' : v === 'preview' ? 'Тест' : 'Клуч'}
            </button>
          ))}
        </div>
        <div id="action-buttons" className={`flex items-center gap-3 transition-all duration-500 ${showTutorial && tutorialStep === 5 ? 'ring-[8px] ring-indigo-500/50 shadow-2xl relative z-[120] bg-white rounded-3xl p-1' : ''}`}>
          <button onClick={handlePrint} className="bg-indigo-600 text-white px-6 py-2.5 rounded-2xl text-[10px] font-black uppercase flex items-center gap-2 shadow-xl hover:bg-indigo-700 transition active:scale-95">
            <Printer size={16} /> Печати
          </button>
        </div>
      </nav>

      <div className="max-w-[1600px] mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-12 gap-10">
        {view === 'editor' && (
          <aside className="lg:col-span-3 space-y-6 print:hidden">
            {/* Bank Tab */}
            <div id="bank-tab" className={`bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200 transition-all duration-500 ${showTutorial && tutorialStep === 1 ? 'ring-[10px] ring-indigo-500/50 shadow-2xl relative z-[120] scale-105 bg-white' : ''}`}>
               <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 flex items-center gap-2 font-sans"><Library size={14}/> Банка на Прашања</h3>
               <div className="space-y-2 max-h-[250px] overflow-y-auto pr-1 custom-scrollbar text-center py-4 text-slate-300 italic text-[10px]">
                  {questionBank.length === 0 ? "Сè уште нема зачувани прашања." : questionBank.map(q => (
                    <div key={q.id} className="p-3 bg-slate-50 rounded-xl border border-slate-100 flex flex-col gap-2 group/bank text-left not-italic">
                       <p className="text-[10px] font-bold text-slate-600 line-clamp-2">{q.text}</p>
                       <button onClick={() => setQuestions([...questions, {...q, id: Date.now()}])} className="text-[9px] font-black text-indigo-600 uppercase hover:underline">Додај во тест</button>
                    </div>
                  ))}
               </div>
            </div>

            {/* Toolbox */}
            <div id="toolbox-sidebar" className={`bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200 transition-all duration-500 ${showTutorial && tutorialStep === 2 ? 'ring-[10px] ring-indigo-500/50 shadow-2xl relative z-[120] scale-105 bg-white' : ''}`}>
               <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 flex items-center gap-2"><Layout size={14}/> Формати</h3>
               <div className="space-y-6 overflow-y-auto max-h-[50vh] pr-2 custom-scrollbar">
                  {['базични', 'текстуални', 'логички', 'напредни'].map(cat => (
                    <div key={cat} className="space-y-2">
                      <p className="text-[9px] font-black text-indigo-400 uppercase ml-2 mb-1 tracking-widest">{cat}</p>
                      <div className="grid grid-cols-1 gap-1">
                        {questionTypes.filter(t => t.cat === cat).map(t => (
                          <button key={t.id} onClick={() => addQuestion(t.id)} className="w-full flex items-center gap-3 p-3 rounded-2xl text-[12px] font-bold text-slate-600 hover:bg-indigo-50 hover:text-indigo-700 transition border border-transparent hover:border-indigo-100 group">
                            <span className="p-2 bg-slate-50 rounded-xl group-hover:bg-white transition">{t.icon}</span> {t.label}
                          </button>
                        ))}
                      </div>
                    </div>
                  ))}
               </div>
            </div>

            {/* Settings */}
            <div id="advanced-settings" className={`bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200 transition-all duration-500 ${showTutorial && tutorialStep === 3 ? 'ring-[10px] ring-indigo-500/50 shadow-2xl relative z-[120] scale-105 bg-white' : ''}`}>
               <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 flex items-center gap-2 font-sans"><Settings size={14}/> Напредни Поставки</h3>
               <div className="space-y-4">
                  <div className="flex items-center justify-between">
                     <span className="text-xs font-bold text-slate-600">ZipGrade Стил</span>
                     <button onClick={() => setTestInfo({...testInfo, zipGrade: !testInfo.zipGrade})} className={`w-10 h-5 rounded-full transition-all flex items-center px-1 ${testInfo.zipGrade ? 'bg-indigo-600 justify-end' : 'bg-slate-200 justify-start'}`}><div className="w-3 h-3 bg-white rounded-full shadow-sm"></div></button>
                  </div>
                  <div className="flex items-center justify-between">
                     <span className="text-xs font-bold text-slate-600">Под-нумерирање</span>
                     <button onClick={() => setTestInfo({...testInfo, subNumbering: !testInfo.subNumbering})} className={`w-10 h-5 rounded-full transition-all flex items-center px-1 ${testInfo.subNumbering ? 'bg-indigo-600 justify-end' : 'bg-slate-200 justify-start'}`}><div className="w-3 h-3 bg-white rounded-full shadow-sm"></div></button>
                  </div>
               </div>
            </div>
          </aside>
        )}

        <main id="test-canvas" className={`${view === 'editor' ? 'lg:col-span-9' : 'lg:col-span-12'} transition-all duration-500`}>
          <div id="test-paper" className={`relative bg-white shadow-2xl min-h-[1123px] p-[2.5cm] print:p-0 print:shadow-none print:border-none border rounded-sm overflow-hidden flex flex-col transition-all duration-500 ${showTutorial && tutorialStep === 4 ? 'ring-[15px] ring-indigo-500/30 relative z-[120] scale-[0.98]' : ''}`}>
             <header className="relative z-10 border-b-[4px] border-slate-900 pb-10 mb-16 text-slate-900">
                <div className="flex justify-between items-start mb-10 font-sans">
                   <div className="space-y-2">
                      <div className="flex items-center gap-2 text-2xl font-black uppercase tracking-tight">
                         {view === 'editor' ? (
                            <>
                              <input value={testInfo.schoolType} onChange={e => setTestInfo({...testInfo, schoolType: e.target.value})} className="w-16 bg-transparent border-b border-dashed border-slate-200 outline-none" />
                              <input value={testInfo.school} onChange={e => setTestInfo({...testInfo, school: e.target.value})} className="w-80 bg-transparent border-b border-dashed border-slate-200 outline-none" />
                            </>
                         ) : `${testInfo.schoolType} ${testInfo.school}`}
                      </div>
                      <div className="flex gap-4 text-[11px] font-black text-slate-400 uppercase tracking-widest">
                         <span>Предмет: {testInfo.subject}</span>
                         <span>Наставник: {testInfo.teacher}</span>
                      </div>
                   </div>
                   <div className="text-right">
                      <h2 className="text-2xl font-black text-indigo-700 uppercase tracking-tighter leading-none">{view === 'answerKey' ? 'КЛУЧ СО ОДГОВОРИ' : testInfo.title}</h2>
                      <span className="text-[10px] font-black text-slate-300 block mt-2 uppercase">Датум: {testInfo.date}</span>
                   </div>
                </div>
                {view !== 'answerKey' && (
                  <div className="grid grid-cols-6 gap-10 mt-16 font-sans">
                    <div className="col-span-4 border-b-2 border-slate-200 pb-2 text-[10px] font-black text-slate-300 uppercase tracking-[0.3em]">Ученик:</div>
                    <div className="col-span-2 border-b-2 border-slate-200 pb-2 text-[10px] font-black text-slate-300 uppercase text-right">Поени: _____ / {totalPoints}</div>
                  </div>
                )}
             </header>

             <div className="relative z-10 space-y-20 flex-grow">
               {questions.map((q, idx) => {
                 let displayNum = (idx + 1).toString();
                 if (testInfo.subNumbering && q.subNum) displayNum = q.subNum;
                 return (
                 <div key={q.id} className="relative group">
                    {view === 'editor' && (
                       <div className="absolute -left-16 top-0 flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition print:hidden z-20">
                          <button onClick={() => setQuestions(questions.filter(qu => qu.id !== q.id))} className="p-2.5 bg-red-50 text-red-500 rounded-xl hover:bg-red-500 hover:text-white transition shadow-sm"><Trash2 size={16} /></button>
                          <button onClick={() => saveToBank(q)} className="p-2.5 bg-blue-50 text-blue-500 rounded-xl hover:bg-blue-500 hover:text-white transition shadow-sm" title="Зачувај"><Save size={16} /></button>
                          <div className="bg-white p-2 rounded-xl border flex flex-col items-center shadow-sm">
                             <span className="text-[8px] font-black text-slate-400 uppercase">Бод</span>
                             <input type="number" value={q.points} onChange={e => setQuestions(questions.map(qu => qu.id === q.id ? {...qu, points: e.target.value} : qu))} className="w-8 text-xs font-black text-center outline-none bg-slate-50 rounded" />
                          </div>
                       </div>
                    )}
                    <div className="flex gap-6 mb-6 items-start font-sans">
                       <span className="bg-slate-900 text-white w-9 h-9 rounded-xl flex items-center justify-center text-sm font-black flex-shrink-0 shadow-lg">{displayNum}</span>
                       <div className="flex-1">
                          {view === 'editor' ? (
                             <textarea rows="1" value={q.text} onChange={e => setQuestions(questions.map(qu => qu.id === q.id ? {...qu, text: e.target.value} : qu))} className={`w-full font-bold text-lg bg-slate-50/30 p-4 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-100 transition resize-none leading-relaxed ${testInfo.alignment === 'justify' ? 'text-justify' : ''}`} placeholder="Внесете задача..." />
                          ) : (
                            <div className={`text-lg font-bold text-slate-800 leading-relaxed pr-10 ${testInfo.alignment === 'justify' ? 'text-justify' : ''}`}>
                               <RenderContent text={q.text} view={view} />
                            </div>
                          )}
                       </div>
                    </div>
                    <div className="ml-16 font-sans">
                       {q.type === 'multiple' && (
                          <div className={`grid gap-4 grid-cols-${q.columns || 1}`}>
                             {q.options.map((opt, oIdx) => (
                                <div key={oIdx} className={`flex items-center gap-4 p-4 rounded-2xl border-2 transition ${view === 'answerKey' && q.correct === oIdx ? 'bg-emerald-50 border-emerald-400 shadow-sm' : 'border-slate-50 bg-slate-50/20'}`}>
                                   <div className={`w-8 h-8 ${testInfo.zipGrade ? 'rounded-[30%] rotate-45' : 'rounded-full'} border-2 flex items-center justify-center text-[11px] font-black ${view === 'answerKey' && q.correct === oIdx ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-800 text-slate-800 bg-white shadow-sm'}`}>
                                      <span className={testInfo.zipGrade ? '-rotate-45' : ''}>{String.fromCharCode(97 + oIdx).toUpperCase()}</span>
                                   </div>
                                   {view === 'editor' ? <input value={opt} onChange={e => {
                                      const n = [...q.options]; n[oIdx] = e.target.value; setQuestions(questions.map(qu => qu.id === q.id ? {...qu, options: n} : qu));
                                   }} className="bg-transparent border-b w-full outline-none text-base font-bold" /> : <RenderContent text={opt} view={view} className="text-base font-bold text-slate-700" />}
                                   {view === 'editor' && <button onClick={() => setQuestions(questions.map(qu => qu.id === q.id ? {...qu, correct: oIdx} : qu))} className={`p-1 transition ${q.correct === oIdx ? 'text-emerald-500' : 'text-slate-200'}`}><CheckCircle2 size={18} /></button>}
                                </div>
                             ))}
                          </div>
                       )}
                       {(q.type === 'essay' || q.type === 'short-answer') && (
                          <div className="space-y-6 mt-8">
                             {[...Array(q.type === 'essay' ? 10 : 3)].map((_, i) => (
                                <div key={i} className="border-b-2 border-slate-100 border-dotted w-full h-10" />
                             ))}
                          </div>
                       )}
                    </div>
                 </div>
               )})}
             </div>

             <footer className="relative z-10 mt-40 pt-16 border-t-[6px] border-slate-900 flex justify-between items-end pb-8 text-slate-900 font-sans">
                <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">{testInfo.schoolType} {testInfo.school} • v6.0 Pro</p>
                <div className="text-center w-80">
                   <div className="border-b-4 border-slate-900 mb-4 h-16" />
                   <p className="text-xs font-black uppercase tracking-[0.4em] leading-none">Потпис на Наставник</p>
                </div>
             </footer>
          </div>
        </main>
      </div>

      <style dangerouslySetInnerHTML={{ __html: `
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&display=swap');
        body { font-family: 'Manrope', sans-serif; overflow-x: hidden; }

        @media print {
          @page { margin: 0; size: A4; }
          body { margin: 0 !important; padding: 0 !important; background: white !important; }
          #main-nav, aside, .print\\:hidden, #nav-tabs, #action-buttons, .fixed { display: none !important; }
          #test-canvas { 
            margin: 0 !important; padding: 0 !important; width: 100% !important; 
            position: absolute !important; left: 0 !important; top: 0 !important;
            box-shadow: none !important; transform: none !important;
            z-index: 1 !important;
          }
          #test-paper { border: none !important; border-radius: 0 !important; box-shadow: none !important; width: 100% !important; min-height: 100vh !important; }
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 20px; }
      `}} />
    </div>
  );
};

export default App;